<script type="text/javascript">
$(document).ready( function() {
	$('#related_content').stickySidebar();
	
	$('#tabs ul').idTabs();
	
	
	var map;
    var myOptions = {
    	zoom: 14,
    	center: new google.maps.LatLng(37.87159260,-122.2727470), // Berkeley, CA
    	mapTypeId: google.maps.MapTypeId.ROADMAP
	};
   	map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);

    var geocoder = new google.maps.Geocoder();
	var address = $.trim(address = $('#question_location').val().replace(/[\t\n\r]/gi, " "));
	    geocoder.geocode( { 'address': address}, function(results, status) {
	      if (status == google.maps.GeocoderStatus.OK) {
	        map.setCenter(results[0].geometry.location);
	        var marker = new google.maps.Marker({
	            map: map,
	            position: results[0].geometry.location
	        });
	      }
	});

	$('#challenge_location').blur( function() {
		var challenge_geocoder = new google.maps.Geocoder();
		var challenge_address = $.trim(challenge_address = $('#challenge_location').val().replace(/[\t\n\r]/gi, ""));
		    geocoder.geocode( { 'address': challenge_address}, function(results, status) {
		      if (status == google.maps.GeocoderStatus.OK) {		      
				$('#challenge_lat').attr('value', results[0].geometry.location.lat());
				$('#challenge_lng').attr('value', results[0].geometry.location.lng());
		      }	
		});
	});	
	
	$('#challenge_categories_id').attr('value', '<%= @question.categories_id %>');
	$('#challenge_location').attr('value', address);
	
	var qr_url = window.location.href;
	qr_url = (qr_url.indexOf('?') != -1) ? qr_url.substring(0, qr_url.indexOf('?')) : qr_url;
	qr_url = (qr_url.indexOf('#') != -1) ? qr_url.substring(0, qr_url.indexOf('#')) : qr_url;
	$('#QR').attr('href', 'https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=' + qr_url + '&choe=UTF-8');
	
	$('#share').attr('href', 'mailto:?subject=[City%20Sandbox]%20<%=@question.user.login%>%20has%20shared%20a%20link%20with%20you!&body=' + qr_url);
	
	$('#unfollow_user').click(function(){
		var params = {};
		params['item_to_follow'] = '<%= @question.user.id %>';
		params['type'] = 'User';
		$.get('/unfollow', params);
		$('#unfollow_user').hide();
		$('#follow_user').show();
	});
	
	$('#follow_user').click(function(){
		var params = {};
		params['item_to_follow'] = '<%= @question.user.id %>';
		params['type'] = 'User';
		$.get('/follow', params);
		$('#follow_user').hide();
		$('#unfollow_user').show();
	});
	
	$('#unfollow').click(function(){
		var params = {};
		params['item_to_follow'] = '<%= @question.id %>';
		params['type'] = 'Question';
		$.get('/unfollow', params);
		$('#unfollow').hide();
		$('#follow').show();
	});
	
	$('#follow').click(function(){
		var params = {};
		params['item_to_follow'] = '<%= @question.id %>';
		params['type'] = 'Question';
		$.get('/follow', params);
		$('#follow').hide();
		$('#unfollow').show();
	});
	
	if ('<%= @followed %>' == 'true') {
		$('#follow').hide();
	} else {
		$('#unfollow').hide();
	}
	if ('<%= @followed_user %>' == 'true') {
		$('#follow_user').hide();
	} else {
		$('#unfollow_user').hide();
	}

	$(window).resize(function() {
		$('#content').css('margin-left', ($(window).width()-960)/2 + 'px');
	});
	$('#content').css('margin-left', ($(window).width()-960)/2 + 'px');
});
</script>
<style type="text/css">
</style>
<div id='content'>
<div id='user_sidebar'>
	<% if @question.anonymous != 1 %>
		<b>About <%= @question.user.login %> </b>
		<br>
		<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'100x100', :alt => "User avatar" %>
		<%= @question.user.picture %> 
		<br>
		<b>Joined:</b> <%= @question.user.created_at.strftime("%Y %b %d")%>
		<br>
		<b>Questions:</b> <%= @question.user.questions.length %>
		<br>
		<b>Responses:</b> <%= @question.user.response_questions.length + @question.user.response_challenges.length + @question.user.response_events.length %>
		<br>
		<b>Challenges:</b> <%= @question.user.challenges.length %>
		<br>
		<br>
		<b><%= link_to 'Recent Activity', summary_path, :class=>'black_link' %></b>
		<br>
		<b><a href='javascript:;' id='unfollow_user' class='black_link'>Unfollow</a></b>
		<b><a href='javascript:;' id='follow_user' class='black_link'>Follow</a></b>
	<% end %>
</div>
<div id='main_question_content'>
<div id='question_main'>
	<span id='question_map'>
		<div id="map_canvas"></div>
		<%=h @question.location %>
		<%= hidden_field(:question, :location) %>
	</span>
	<span id='question_title_display'>
		<b><%= @question.title %></b>
	</span>
	<br><br>
	<span id='question_author'>
		<% if @question.anonymous != 1 %>
		<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'30x30', :alt => "User avatar" %>
		<%=h @question.user.picture %> by <%= @question.user.login %> |
		<% else %>
		Anonymous | 
		<% end %>
		<%= @question.created_at.strftime("%Y %b %d") %> | <%= @category.category %> |
		<a href='javascript:;' id='unfollow' class='black_link'>Unfollow | </a> 
		<a href='javascript:;' id='follow' class='black_link'>Follow | </a> 
		<a href='' class='black_link' id='share'> Share </a> |
		<a id='QR' class='black_link'>QR</a>
	</span>
	<br>
	<br>
	<div id='form_links'>
	<ul>
	<li><a href="#response_form" class="black_link" onclick='$("#responses_tab").click();'>Add Response</a></li>
	<li><a href="#challenge_form" class="black_link" onclick='$("#challenges_tab").click();'>Add Challenge</a></li>
	</ul>
	</div>
</div>
<% if @question.description.length > 0 %>
	<br>
	<div class='individual'>
		<span id='question_description'>
			<%= @question.description %> 
		</span>
	</div>
<% end %>
<div id='tabs'>
<br>
<div id='tabs_menu'>	
<ul>
	<li><b><a href="#responses" id='responses_tab'>Responses</a></b></li>
	<li>|</li>
	<li><b><a href="#challenges" id='challenges_tab'>Challenges</a></b></li>
	<li>|</li>
	<li><b><a href="#events">Events</a></b></li>
</ul>
</div>
<br>
<div id='responses'>
	<% @question.response_questions.reverse_each do |r| %>
	<div class='entry_main'>
		<div class='entry_author'>
			<% if r.anonymous == 1 %>
				<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'60x60', :alt => "User avatar" %>
				<%=h r.user.picture %> 
				<br>
				Anonymous
				<br>
			<% else %>
				<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'60x60', :alt => "User avatar" %>
				<%=h r.user.picture %> 
				<br>
				<%=h r.user.login %>
				<br>
			<% end %>
			<%= r.created_at.strftime("%Y %b %d") %>
		</div>
		<div class='latest_response'>
		    <%=h r.response %>
		</div>
	</div>
		<br>
	<% end %>
	<div id='response_form'>
		Add Response
		<br>
		<%= form_for([@question, ResponseQuestion.new]) do |r| %>
		    <%= r.text_area :response, :rows => 3 %>
			<br>
			<%= r.check_box :anonymous %>
			<%= r.label 'Post anonymously' %>
			<br>
		    <%= r.submit "Submit" %>
		<% end %>
	</div>
</div>

<div id='challenges'>
	<% @question.challenges.each do |c| %>
		<div class='individual'>
			<div class='entry_author'>
				<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'60x60', :alt => "User avatar" %>
				<%=h c.user.picture %> 
				<br>
				<%=h c.user.login %>
				<br>
				<%= c.created_at.strftime("%Y %b %d") %>
				<br>
			</div>
			<div class='entry_title'>
				<b><%= link_to c.title, c, :class=>'black_link' %></b>
			</div>	
			<br>
			<div class='latest_response'>
			    <%=h c.description %>
				<ul>
					<li><b> Submission Deadline: </b> <%= c.submission_deadline.strftime("%Y %b %d") %> </li>
					<li><b> Vote Deadline: </b> <%= c.vote_deadline.strftime("%Y %b %d") %> </li>
				</ul>
			</div>
		</div>
		<br>
	<% end %>

	<div id='challenge_form'>
		Add Challenge
		<br>
		<%= form_for [@challenge, Challenge.new] do |c| %>
		  <%= c.hidden_field :lat %>
		  <%= c.hidden_field :lng %>
		  <p>
		    <%= c.label :title, "Title" %>
			<br>
		    <%= c.text_field :title %>
		  </p>
			<%= c.hidden_field :question_id, :value => @question.id %>
		  <p>
		    <%= c.label :description, "Description" %>
			<br>
		    <%= c.text_area :description, :rows=>3 %>
		  </p>
		  <p>
			<%= c.label :location %>
			<br>
			<%= c.text_area :location, :rows=>2 %>
		  </p>
		  <p>
		    <%= c.label :submission_deadline, "Proposal Deadline" %><br />
		    <%= c.datetime_select :submission_deadline %>
		  </p>
		  <p>
		    <%= c.label :vote_deadline , "Vote Deadline" %><br />
		    <%= c.datetime_select :vote_deadline %>
		  </p>
		  <p>
			<%= c.label 'Categories: ' %>
			<br>
			<%= c.select(:categories_id, Categories.all.collect {|c| [ c.category, c.id] }, {:include_blank => 'Other'})%>
			<br>
		  </p>
		  <p>
		    <%= c.submit "Submit" %>
		  </p>
		<% end %>
</div>
</div>
<div id='events'>
	<% @question.challenges.each do |challenge| %>
		<% challenge.events.each do |e| %>
		<div class='entry_main'>
			<div class='entry_author'>
				<%= image_tag "../images/default_avatar.png", :class=>'user_avatar', :size=>'60x60', :alt => "User avatar" %>
				<%=h e.user.picture %> 
				<br>
				<%=h e.user.login %>	
				<br>
				<%= e.created_at.strftime("%Y %b %d") %>
				<br>
			</div>
			<div class='entry_title'>
				<b><%= link_to e.title, e, :class=>'black_link' %></b>
			</div>
			<div id='challenge_dates'>
				<ul>
					<li><b> Date: </b> <%= e.time.strftime("%Y %b %d") %> </li>
				</ul>
			</div>	
			<div class='latest_response'>
			    <%=h e.description %>
			</div>
		</div>
		<br>
		<% end %>
	<% end %>
</div>
</div>
<br>
<% if @question.user == current_user %>
	<%= link_to 'Edit', edit_question_path(@question), :class=>'black_link' %> |
<% end %>
<%= link_to 'Back To Summary', summary_path, :class=>'black_link' %>
</div>
</div>
</div>